<!DOCTYPE html>
<meta charset="utf-8">
<title>Homework 2 Graph</title>
<style>
  .link {
  fill: none;
  stroke-width: 1.5px;
  stroke: #666;
  }

  .icon {

     width: 100px;
    height: auto;
}

  .node {
    fill: #66CC66;
    stroke: #000;
    stroke-width: 1px;
  }

  .node:hover {
    fill: red;
  }

  #tooltip {
    position: absolute;
    width: 200px;
    height: auto;
    padding: 10px;
    background-color: white;
    -webkit-border-radius: 10px;
    -moz-border-radius: 10px;
    border-radius: 10px;
    -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
    -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
    box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
    pointer-events: none;
  }

  #tooltip.hidden {
    display: none;
  }

  #tooltip p {
    margin: 0;
    font-family: sans-serif;
    font-size: 16px;
    line-height: 20px;
  }

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
  <form>
  Layout:
    <label><input type="radio" name="layout" value="force" checked> Force</label>
    <label><input type="radio" name="layout" value="random" > Random</label>
    <label><input type="radio" name="layout" value="radial"> Radial</label>  
  </form>
  <form>
  Color:
    <label><input type="radio" name="color" value="nocolor" checked> None</label>
    <label><input type="radio" name="color" value="color_cat2" > Branch</label>
  </form>
  <div id="tooltip" class="hidden">
        <p><span id="value">100</span></p>
  </div>
<script>

var repository = "neovim/neovim"

d3.json("https://api.github.com/repos/" + repository + "/branches", function(branch) {

 
  var commits = {}
  var remaining = branch.length
  branch.map(function(d) { 
    d3.json("https://api.github.com/repos/" + repository + "/commits?per_page=100&sha=" + d.commit.sha, function(data) {
      commits[d.name] = data;
      --remaining;
    if (remaining == 0) 
      {
        doSomething();
      }
  })
  })
  function doSomething() {


    d3.json("https://api.github.com/repos/neovim/neovim/contributors" , function(authors) {

    var width = 1000,
        height = 700;
        padding = 10;


    radius = Math.min(width, height) / 2;

      
    var color = d3.scale.ordinal()
        .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);


    var arc = d3.svg.arc()
        .outerRadius(radius - 10)
        .innerRadius(radius - 70);

    var pie = d3.layout.pie()
        .sort(null)
        .value(function(d) { return d.population; });

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    var fill = d3.scale.category10();

    var graph = {nodes:[], links:[]};

   
    var id =0;
    var allcommits = []

    
    for (var hr in commits)
    {
      graph.nodes.push(commits[hr]);
      for (var nodes in commits[hr]) 
      { 
        
        commits[hr][nodes].date = Date.parse(commits[hr][nodes].commit.committer.date)
        commits[hr][nodes].branch = hr;
        commits[hr][nodes].branchid = id
      }
        allcommits = allcommits.concat(commits[hr])
        id++
    }

    
  var connections = {links:[]};


  allcommits.map(function(d, i) {

  authors.map(function(e, j) {
 
    if(d.author && d.author.id == e.id)
    {

    branch.map(function(f, g) {

    if(d.branch == f.name)
    {
      
      connections.links.push({"source": d, "target": f})
    }
     
    })
    }
  })
    
  })

  console.log(connections);
    
    // Generate the force layout
    var force = d3.layout.force()
        .size([width/8 - 100, height/8 - 100])
        .charge(-250)
        .linkDistance(10)
        .on("tick", tick)
        .on("start", function(d) {})
        .on("end", function(d) {})

    function tick(d) {

      graph_update(0);
    }

    
    function random_layout() {
      
      force.stop();

      graph.nodes.forEach(function(d, i) {
        d.x = width/8 - width*Math.random()/4;
        d.y = height/8 - height*Math.random()/4;
      })
      graph_update(500);
    }

    function force_layout() {


     force.nodes(graph.nodes)
          .links(graph.links)
          .start();
    }

    
    function radial_layout() {

      force.stop();

      var r = height/3;

      var arc = d3.svg.arc()
              .outerRadius(r);

      var pie = d3.layout.pie()
      .sort(function(a, b) { return a.branchid - b.branchid;}) 
              .value(function(d, i) { return 1; }); 

      graph.nodes = pie(graph.nodes).map(function(d, i) {
        d.innerRadius = 0;
        d.outerRadius = r;
        d.data.x = arc.centroid(d)[0]
        d.data.y = arc.centroid(d)[1]
        d.data.endAngle = d.endAngle; 
        d.data.startAngle = d.startAngle; 
        return d.data;
      })
      graph_update(500);
    }

    function category_color_branch() {
      d3.selectAll("circle").transition().duration(500).style("fill", function(d) { return fill(d); });
    }

    var offset_x = -15

    function graph_update(delay) {
     
     var line = d3.svg.line()
        .x(function (d) {return d.x;})
        .y(function (d) { return  d.y;})
    
      line.interpolate("step")
      link.transition().duration(delay)
          .attr("d", function (d) {
              return line([{
                x: d.source.x,
                y: d.source.y
              }, {
                x: d.source.x + offset_x,
                y: d.source.y 
              }, {
                x: d.target.x + offset_x,
                y: d.target.y 
              }, {
                x: d.target.x,
                y: d.target.y
              }])})
       
        link.transition().duration(delay)
        .attr("d", function(d) {
         return line([{
                x: d.source.x,
                y: d.source.y
              },  {
                x: d.target.x,
                y: d.target.y 
              }, ])})
      
      node.transition().duration(delay)
          .attr("transform", function(d) { 
            return "translate("+d.x+","+d.y+")"; 
          });
    }

    d3.select("input[value=\"force\"]").on("click", force_layout);
    d3.select("input[value=\"random\"]").on("click", random_layout);
    d3.select("input[value=\"radial\"]").on("click", radial_layout);
    d3.select("input[value=\"color_cat2\"]").on("click", category_color_branch);
    d3.select("input[value=\"nocolor\"]").on("click", function() {
      d3.selectAll("circle").transition().duration(500).style("fill", "#66CC66");
    })
    d3.select("input[value=\"nosize\"]").on("click", function() {
      d3.selectAll("circle").transition().duration(500).attr("r", 5);
    })

    // get links set up
    var link = svg.selectAll(".link")
                  .data(graph.links)
                  .enter().append("path")
                  .attr("class", function(d) { return "link"})
                  .attr("marker-end", "url(#end)")


 // get links set up
    var connect = svg.selectAll(".link")
                  .data(connections.links)
                  .enter().append("path")
                  .attr("class", function(d) { return "link"})
                  .attr("marker-end", "url(#end)")


    var node = svg.selectAll(".node")
                  .data(graph.nodes)
                .enter()
                  .append("g").attr("class", "node");

    node.append("circle")
        .attr("r", function(d) { 
         return 5 + d.length/2 })
        .on("mouseover", function(d) {
          console.log(d)

          var xPosition = d.x; 
          var yPosition = d.y; 
          console.log(d)
          d3.select("#tooltip")
              .style("left", xPosition + "px")
              .style("top", yPosition + "px")
              .select("#value")
              .html(  "<br/>" );
          d3.select("#tooltip").classed("hidden", false); 

        })
        .on("mouseout", function() {
          d3.select("#tooltip").classed("hidden", true); // Hide the text bubble
        })


    force_layout();

    var m = 2;
authors.forEach(function(d) {
    
    
    d.population = d.contributions;
    
  });

  var g = svg.selectAll(".arc")
      .data(pie(authors))
    .enter().append("g")
      .attr("class", "arc");

  g.append("path")
      .attr("d", arc)
      .style("fill", function(d) { return color(d.data.login); });

  g.append("text")
      .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
      .attr("dy", ".35em")
      .style("text-anchor", "middle")
      .style("font-size", "15px")
      

d3.selectAll(".arc").on("mouseover", function(d) {

var xPosition = 20;
var yPosition = 100;


//Update the tooltip position and value
d3.select("#tooltip")
  .style("left", xPosition + "px")
  .style("top", yPosition + "px")
  .select("#value")
  .html('<h4>' + d.data.login + '</h4>'  + 'Contributions: ' + d.data.contributions + '<br> <img class = "icon" src="' + d.data.avatar_url + '">');

//Show the tooltip
d3.select("#tooltip").classed("hidden", false);

})

.on("mouseout", function() {

//Hide the tooltip
d3.select("#tooltip").classed("hidden", true);

})
 })} 
});
</script>
</body>
</html>